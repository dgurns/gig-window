# Compile the API app
FROM node:10.15-alpine as compile-api

ARG DATABASE_HOST
ARG DATABASE_PORT
ARG DATABASE_USERNAME
ARG DATABASE_PASSWORD
ARG DATABASE_NAME
ARG RTMP_ORIGIN
ARG RTMP_PATH=/stream
ARG UI_ORIGIN
ARG COOKIE_SESSION_KEY
ARG AWS_REGION
ARG AWS_ACCESS_KEY_ID
ARG AWS_SECRET_ACCESS_KEY
ARG AWS_S3_BUCKET
ARG STRIPE_SECRET_KEY

WORKDIR /app

COPY package.json .
COPY yarn.lock .
COPY tsconfig.json .

RUN apk add yarn && yarn install --frozen-lockfile --network-timeout 100000

COPY src src/

RUN DATABASE_HOST=$DATABASE_HOST \
  DATABASE_PORT=$DATABASE_PORT \
  DATABASE_USERNAME=$DATABASE_USERNAME \
  DATABASE_PASSWORD=$DATABASE_PASSWORD \
  DATABASE_NAME=$DATABASE_NAME \
  RTMP_ORIGIN=$RTMP_ORIGIN \
  RTMP_PATH=$RTMP_PATH \
  UI_ORIGIN=$UI_ORIGIN \
  COOKIE_SESSION_KEY=$COOKIE_SESSION_KEY \
  AWS_REGION=$AWS_REGION \
  AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID \
  AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY \
  AWS_S3_BUCKET=$AWS_S3_BUCKET \
  STRIPE_SECRET_KEY=$STRIPE_SECRET_KEY \
  yarn build:dist

RUN npm prune --production

# Run the compiled API app with only production dependencies
FROM node:10.15-alpine

COPY --from=compile-api /app/dist ./dist
COPY --from=compile-api /app/node_modules ./node_modules

ENV NODE_ENV=production
ENV NODE_PATH=./dist

EXPOSE 4000

CMD ["node", "dist/index.js"]